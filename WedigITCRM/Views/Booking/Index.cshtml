
@{
    Layout = null;
}

@model BookingAPIModel

<link href='https://unpkg.com/fullcalendar@3.10.1/dist/fullcalendar.min.css' rel='stylesheet' />

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.2/jquery.modal.css">

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


<link href="~/lib/css/custom.css" rel="stylesheet" />

<script src='https://unpkg.com/moment@2.24.0/min/moment.min.js'></script>
<script src='https://unpkg.com/jquery@3.4.1/dist/jquery.min.js'></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
<script src='https://unpkg.com/fullcalendar@3.10.1/dist/fullcalendar.min.js'></script>
<script src='https://unpkg.com/fullcalendar@3.10.1/dist/locale-all.js'></script>


<div class="formcontainer">

    <br />
    <br />

    <div class="row">
        <div class="col-sm-1">
        </div>
        <div class="col-sm-2">
            <div class="row">
                <div id="selectresourcediv">
                    <label for="selectresource">Medarbejder</label>
                    <select class="form-control form-control-sm" id="selectresource">
                    </select>
                </div>
                <br />
                <div id="resourceColorTagdiv">

                </div>
                <br />
                <div id="selectservicediv">
                    <label for="selectbookingservice">Ydelse</label>
                    <select class="form-control form-control-sm" id="selectbookingservice">
                    </select>
                </div>
                <br />
                <br />
                <br />
                <form>
                    <div class="form-group">
                        <label for="bookeremail">Email</label>
                        <input type="text" class="form-control form-control-sm" id="bookeremail" placeholder="Email">
                        <div id="bookeremailerror" class="text-danger"></div>
                    </div>
                    <div class="form-group">
                        <label for="bookercellphone">Mobilnummer</label>
                        <input type="text" class="form-control form-control-sm" id="bookercellphone" aria-describedby="emailHelp" placeholder="Mobilnummer">
                        <div id="bookercellphoneerror" class="text-danger"></div>
                    </div>
                    <div class="form-group">
                        <label for="bookername">Navn</label>
                        <input type="text" class="form-control form-control-sm" id="bookername" aria-describedby="emailHelp" placeholder="Navn">
                        <div id="bookernameerror" class="text-danger"></div>
                    </div>
                    <div class="form-group">
                        <input asp-for="@Model.BookingApikey" id="bookingapikey" hidden />
                    </div>
                    <div id="buttonloginbookerdiv" class="form-group">
                        <button id="loginbutton" type="button" class="btn btn-primary">Logind</button>
                    </div>
                    <div id="buttonregistratebookerdiv" class="form-group">
                        <button id="registratebutton" type="button" class="btn btn-primary">Registrer</button>
                    </div>

                </form>
            </div>
        </div>
        <div class="col-sm-8">
            <div id="dialogserviceandresource">
                <form>
                    <div class="form-group">
                        <label for="dialogselectservice">Ydelse</label>
                        <select id="dialogselectservice" name="dialogselectservice" class="form-control form-control-sm">
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventstartdate">Dato</label>
                        <input type="text" id="eventstartdate" name="eventstartdate" class="form-control form-control-sm" disabled />
                    </div>
                    <div class="form-group">
                        <label for="eventstarttime">Tidspunkt</label>
                        <div id="dummy">
                            <input type="text" id="eventstarttime" name="eventstarttime" class="form-control form-control-sm" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="selectedserviceduration">Varighed</label>
                        <input id="selectedserviceduration" name="selectedserviceduration" class="form-control form-control-sm" disabled />
                    </div>
                    <div class="form-group">
                        <label for="freetimeresourcename">Resurse</label>
                        <input id="freetimeresourcename" name="freetimeresourcename" class="form-control form-control-sm" disabled />
                    </div>
                    <br />
                    <div>
                        <input id="displayselectedtime" name="displayselectedtime" hidden />
                    </div>
                    <div>
                        <input id="displayselectedservice" name="displayselectedservice" hidden />
                    </div>

                    <div>
                        <input id="freetimeresource" name="freetimeresource" hidden />
                    </div>

                    <div id="dialogerrorMessage" class="form-group">
                        <label for="errorMessage"></label>
                        <input id="errorMessage" name="errorMessage" class="form-control form-control-sm" />
                    </div>
                </form>
            </div>

            <div id="dialogverifybooking">
                <div>
                    <div id="message"></div>
                    <input id="bookingsmscode" name="bookingsmscode" />
                </div>
            </div>

            <div id="dialogloginerror">
                <div>
                    <div id="dialogloginerrormessagediv"></div>
                    <input id="dialogloginerrormessage" name="dialogloginerrormessage" />
                </div>
            </div>
            <div id="bookingcalendar">
            </div>
        </div>
    </div>
</div>



<script>

    $(document).ready(function () {

        var loggedIn = false;
        var selectedEventObj;

        $("#dialogserviceandresource").hide();
        $("#dialogverifybooking").hide();
        $("#dialogloginerror").hide();

        $('#selectbookingservice').val("0");




        $('#selectresource').bind('change', function () {

            $("#resourceColorTagdiv").html("");


            var resourceId = $(this).val();
            if (resourceId == "0") {
                getAllResources('selectresource');
            }
            else {
                getResource(resourceId, true);
            }



            var serviceId = $('#selectbookingservice').val();

            getAllServices('selectbookingservice', resourceId);

            $('#bookingcalendar').fullCalendar("refetchEvents");

            if (resourceId != "0") {
                $('#selectservicediv').hide();
            }
            else {
                $('#selectservicediv').show();
            }

        });





        $('#selectbookingservice').bind('change', function () {

            var serviceId = $(this).val();

            var resourceId = $('#selectresource').val();
            $('#bookingcalendar').fullCalendar("refetchEvents");

        });

        $('#loginbutton').bind('click', function () {

            if (!$("#bookeremail").val()) {
                var errorStr = "<span>Angiv email</span>";
                $("#bookeremailerror").html(errorStr);
                return;
            }



            var email = $("#bookeremail").val();
            if (validateEmailAddress(email) == false) {
                var errorStr = "<span>Angiv en gyldig email</span>";
                $("#bookeremailerror").html(errorStr);
                return;
            }

            $("#bookeremailerror").html("");

            var bookingAPIkey = $("#bookingapikey").val();

            $.ajax({
                type: "POST",
                url: "/booking/bookerLogin",
                data: 'email=' + email + "&BookingApikey=" + bookingAPIkey,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result.errorString != null && result.errorString != "") {
                        $("#bookeremailerror").html(result.errorString);
                        return;
                    }

                    $("#bookeremailerror").html("Du er logget på nu. Nu kan du booke en tid");

                    $("#buttonloginbookerdiv").hide();
                    $("#buttonregistratebookerdiv").hide();
                    $("#bookercellphone").val(result.cellPhone);
                    $("#bookername").val(result.name)
                    loggedIn = true;
                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });


        });

        $('#registratebutton').bind('click', function () {

            if (!$("#bookeremail").val()) {
                var errorStr = "<span>Angiv email</span>";
                $("#bookeremailerror").html(errorStr);
                return;
            }



            var email = $("#bookeremail").val();
            if (validateEmailAddress(email) == false) {
                var errorStr = "<span>Angiv en gyldig email</span>";
                $("#bookeremailerror").html(errorStr);
                return;
            }

            $("#bookeremailerror").html("");

            var bookerCellphone = $("#bookercellphone").val();

            if (!$("#bookercellphone").val()) {
                var errorStr = "<span>Angiv telefonnummer</span>";
                $("#bookercellphoneerror").html(errorStr);
                return;
            }

            $("#bookercellphoneerror").html("");

            var bookerName = $("#bookername").val();
            if (!$("#bookername").val()) {
                var errorStr = "<span>Angiv navn</span>";
                $("#bookernameerror").html(errorStr);
                return;
            }

            $("#bookernameerror").html("");

            var bookingAPIkey = $("#bookingapikey").val();



            $.ajax({
                type: "POST",
                url: "/booking/bookerRegistration",
                data: 'email=' + email + "&name=" + bookerName + "&cellPhone=" + bookerCellphone + "&BookingApikey=" + bookingAPIkey,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result.errorString != null & result.errorString != "") {
                        $("#bookeremailerror").html(result.errorString);
                        return;
                    }

                    $("#bookercellphone").val(result.cellPhone);
                    $("#bookername").val(result.name);
                    $("#bookeremailerror").html("Du er nu registreret. Du kan logge på nu");

                    $("#buttonregistratebookerdiv").hide();

                    // loggedIn = true;

                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });

        });

        $("#dialogselectservice").change(function () {
            var serviceId = $(this).val();
            $.ajax({
                type: "POST",
                url: "/booking/getBookingService",
                data: 'id=' + serviceId,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#displayselectedservice').val("");
                    var valueStr = result.name + " " + result.jobDescription + " " + result.salesPrice;
                    $('#displayselectedservice').val(valueStr);
                    $('#selectedserviceduration').val(result.duration);


                    var diffInMinutes = selectedEventObj.end.diff(selectedEventObj.start, 'minutes');

                    if (diffInMinutes < result.duration) {
                        $('#dialogerrorMessage').show();
                        $('#errorMessage').val("Der er ikke tid til den valgte service");
                        return;
                    }

                    $('#dialogerrorMessage').hide();
                    $('#errorMessage').val("");

                    var tmpDateTime = new moment(selectedEventObj.end);
                    var tmpEndDateTime = tmpDateTime.subtract(result.duration, 'minutes');


                    if ($('#eventstarttime').data("DateTimePicker") == undefined) {
                        $("#eventstarttime").datetimepicker({
                            format: 'HH:mm',
                            stepping: 15,
                            locale: 'da',
                            // defaultDate: selectedEventObj.start,
                            minDate: selectedEventObj.start,
                            maxDate: tmpEndDateTime
                        });

                        $('#eventstarttime').val(selectedEventObj.start.format('HH:mm'));
                        $('#eventstarttime').datetimepicker('update');
                    }
                    else {
                        $('#eventstarttime').datetimepicker('remove');
                        $('#eventstarttime').val("");
                        $('#eventstarttime').remove();

                        var htmlStr = '<input type="text" id="eventstarttime" name="eventstarttime" class="form-control form-control-sm" />';
                        $('#dummy').append(htmlStr);


                        $("#eventstarttime").datetimepicker({
                            format: 'HH:mm',
                            stepping: 15,
                            locale: 'da',
                            //defaultDate: selectedEventObj.start,
                            minDate: selectedEventObj.start,
                            maxDate: tmpEndDateTime
                        });

                        $('#eventstarttime').val(selectedEventObj.start.format('HH:mm'));
                        $('#eventstarttime').datetimepicker('update');

                        // $("#eventstarttime").datetimepicker.setDate(selectedEventObj.start);
                        //    $('#eventstarttime').val(selectedEventObj.start.format('HH:mm'));
                        // $('#eventstarttime').datetimepicker('update');
                        // $('#eventstarttime').datetimepicker('update', selectedEventObj.start.format("DD-MM-YYYY HH:mm"));
                        //$("#eventstarttime").datetimepicker.setDate(selectedEventObj.start.toDate());
                    }



                    // $('#eventstarttime').datetimepicker.setStartDate(selectedEventObj.start);



                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });
        });

        $("#resourceColorTagdiv").html("");
        getAllResources('selectresource');

        getAllServices('selectbookingservice', "0");


        var now = moment();
        var TheFirstOfCurrentMonth = moment().startOf(now.month());
        var momentDateCalStyleStr = TheFirstOfCurrentMonth.format("YYYY-MM-DD");
        var calendarStartDate = moment(momentDateCalStyleStr);


        var OneYearAhead = now.add(1, 'years');
        var momentDateCalStyleStr = OneYearAhead.format("YYYY-MM-DD");
        var calendarEndDate = moment(momentDateCalStyleStr);


        $(function () {

            $('#bookingcalendar').fullCalendar({
                validRange: {
                    start: calendarStartDate,
                    end: calendarEndDate
                },
                 defaultView: 'agendaWeek',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay,listMonth'
                },
                locale: 'da',
                buttonIcons: false, // show the prev/next text
                weekNumbers: true,
                navLinks: true, // can click day/week names to navigate views
                editable: false,
                selectable: true,
                select: function (start, end, jsEvent, view) {
                    var x = start.format("DD-MM-YYYY, kk:mm");
                    var y = end.format("DD-MM-YYYY, kk:mm");

                },
                dateClick: function (start, end, jsEvent, view) {
                    var x = start.format("DD-MM-YYYY kk:mm");
                    alert('clicked ' + "   " + x);
                },
                eventClick: function (eventObj) {


                    if (!loggedIn) {
                        DialogLoginError();
                        return;
                    }

                    selectedEventObj = eventObj;

                    var calendarEventResourceOwnerId = selectedEventObj.calendarEventResourceOwnerId;
                    $('#freetimeresource').val(calendarEventResourceOwnerId);

                    var bookingStartdate = selectedEventObj.start.format("DD-MM-YYYY");
                    $('#eventstartdate').val(bookingStartdate);

                    getResource(calendarEventResourceOwnerId, false);

                    $('#dialogselectservice').html("");
                    var selectElement = document.getElementById('dialogselectservice');

                    var mainMenuSelectedServiceId = $('#selectbookingservice').val();
                    if (mainMenuSelectedServiceId != "0") {
                        var mainMenuSelectedServiceText = $("#selectbookingservice option:selected").html();
                        var dummy = selectElement.options.add(new Option(mainMenuSelectedServiceText, mainMenuSelectedServiceId));
                        $('#dialogselectservice').trigger('change');
                    }
                    else {
                        getAllServicesArray(calendarEventResourceOwnerId);

                        for (var i = 0; i < serviceArray.length; i++) {
                            selectElement.options.add(new Option(serviceArray[i].text, serviceArray[i].value));
                        }
                    }

                    DialogSelectResourceAndService();
                },
                eventLimit: true, // allow "more" link when too many events
                events: function (start, end, timezone, callback) {

                    var serviceId = $('#selectbookingservice').val();
                    var resourceId = $('#selectresource').val();

                    $.ajax({
                        type: "POST",
                        url: "/booking/getBookingFreeTime",
                        data: 'id=' + resourceId + "&serviceId=" + serviceId,
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        dataType: "JSON",

                        success: function (result) {
                            var events = [];

                            $.each(result, function (i, data) {
                                var momentStartDateDA = moment(data.startDateTime, 'DD-MM-YYYY kk:mm')
                                var momentStartDateCalStyleStr = momentStartDateDA.format("YYYY-MM-DD kk:mm");
                                var startDateTime = moment(momentStartDateCalStyleStr);

                                var momentEndDateDA = moment(data.endDateTime, 'DD-MM-YYYY kk:mm')
                                var momentEndDateCalStyleStr = momentEndDateDA.format("YYYY-MM-DD kk:mm");
                                var endDateTime = moment(momentEndDateCalStyleStr);

                                var AllDayFlag = false;
                                if (data.selectallday == "true") {
                                    AllDayFlag = true;
                                }

                                var selectRepeatFlag = false;
                                if (data.selectRepeat == "true") {
                                    selectRepeatFlag = true;
                                }

                                events.push(
                                    {
                                        _id: data.calEventId,
                                        repeatedId: data.repeatedId,
                                        calendarEventResourceOwnerId: data.calendarEventResourceOwnerId,
                                        title: data.description,
                                        start: startDateTime,
                                        end: endDateTime,
                                        allDay: AllDayFlag,
                                        selectRepeat: selectRepeatFlag,
                                        startDateTimeRange: data.startDateTimeRange,
                                        endDateTimeRange: data.endDateTimeRange,
                                        rangeWeekDaysValues: data.rangeWeekDaysValues,
                                        textColor: "#000000",
                                        backgroundColor: data.eventColor,
                                        borderColor: "#DD5328"
                                    });
                            });

                            callback(events);
                        }
                    });
                }
            });

        });




        function getAllResources(domElementId) {
            $.ajax({
                type: "POST",
                url: "/booking/getAllResources",
                data: 'id=' + "All",
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                success: function (result) {

                    $('#' + domElementId).html("");
                    $('#' + domElementId).val("");

                    $("<option/>", {
                        value: "0",
                        text: "Vælg"

                    }).appendTo('#' + domElementId);

                    $.each(result, function (i, data) {

                        addResourceColorTagDiv(data),
                            $("<option/>", {
                                value: data.id,
                                text: data.jobDescription
                            }).appendTo('#' + domElementId);
                    });

                    $('#' + domElementId).val("0");
                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });


        }


        function getResource(resourceId, AddColorDivFlag) {
            $.ajax({
                type: "POST",
                url: "/booking/getResource",
                data: 'id=' + resourceId,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    $('#freetimeresourcename').val(result.jobDescription);
                    if (AddColorDivFlag) {
                         addResourceColorTagDiv(result);
                    }
                   
                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });


        }

        function getAllServices(domElementId, resourceId) {
            $.ajax({
                type: "POST",
                url: "/booking/getAllBookingServices",
                data: 'id=' + resourceId,
                contentType: "application/x-www-form-urlencoded; charset=utf-8",
                dataType: "json",
                async: false,
                success: function (result) {

                    $('#' + domElementId).html("");
                    $('#' + domElementId).val("");

                    $("<option/>", {
                        value: "0",
                        text: "Vælg"

                    }).appendTo('#' + domElementId);

                    $.each(result, function (i, data) {
                        $("<option/>", {
                            value: data.id,
                            text: data.name

                        }).appendTo('#' + domElementId);
                    });

                    $('#' + domElementId).val("0");
                },

                failure: function (errMsg) {
                    alert(errMsg);
                }
            });


        }




    });

    function DialogSelectResourceAndService() {

        var selected = 0;
        $('#dialogserviceandresource').dialog({
            title: "Vælg",
            buttons: {
                "Ok": function () {
                    var selectedServiceId = $("#dialogselectservice").val();
                    if (selectedServiceId != "0") {
                        var bookerEmail = $("#bookeremail").val();
                        var bookingAPIkey = $("#bookingapikey").val();
                        $.ajax({
                            type: "POST",
                            url: "/booking/sendVerificationSMS",
                            data: 'email=' + bookerEmail + "&bookingAPIkey=" + bookingAPIkey,
                            contentType: "application/x-www-form-urlencoded; charset=utf-8",
                            dataType: "json",
                            async: false,
                            success: function (result) {

                                var htmlstr = "Der er sendt en kode til dig på SMS. Indtast koden nedenfor"
                                $("#message").html(htmlstr);
                                $('#dialogserviceandresource').dialog("close");
                                DialogVerifyBooking();
                            },

                            failure: function (errMsg) {
                                alert(errMsg);
                            }
                        });
                    }
                },
                "Annuller": function () {

                    $(this).dialog("close");
                }
            }
        });
    }

    function DialogVerifyBooking() {

        $('#dialogverifybooking').dialog({
            title: "Book",
            buttons: {
                "Book": function () {
                    var bookerEmail = $("#bookeremail").val();
                    var bookingAPIkey = $("#bookingapikey").val();
                    var selectedServiceId = $("#dialogselectservice").val();
                    var resourceId = $('#freetimeresource').val();
                    var SMSverificationCode = $('#bookingsmscode').val();
                    var BookingStartDateTime = $('#eventstartdate').val() + " " + $('#eventstarttime').val();


                    $.ajax({
                        type: "POST",
                        url: "/booking/book",
                        data: 'bookerEmail=' + bookerEmail + "&bookingAPIkey=" + bookingAPIkey + "&serviceId=" + selectedServiceId + "&resourceId=" + resourceId + "&smsVerificationCode=" + SMSverificationCode + "&BookingStartDateTime=" + BookingStartDateTime,
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        dataType: "json",
                        async: false,
                        success: function (result) {

                            $('#bookingcalendar').fullCalendar("refetchEvents");
                            $('#dialogverifybooking').dialog("close");
                        },

                        failure: function (errMsg) {
                            alert(errMsg);
                        }
                    });
                },
                "Annuller": function () {

                    $(this).dialog("close");
                }
            }
        });
    }

    function DialogLoginError() {

        $("#dialogloginerrormessage").val("Du skal logge på før du kan booke tid");
        $('#dialogloginerror').dialog({
            title: "Logind",
            buttons: {
                "Ok": function () {


                    $(this).dialog("close");
                },
                "Annuller": function () {

                    $(this).dialog("close");
                }
            }
        });
    }

    function validateEmailAddress(email) {


        if (email) {
            var pattern = "[a-z0-9._%+-]+@@[a-z0-9.-]+\.[a-z]{2,3}$";
            var mailformat = /^\w+([\.-]?\w+)*@@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
            var returnStr = email.match(pattern);
            if (returnStr != email) {
                return false;
            }

            return true;
        }
    }

    var serviceArray;

    function getAllServicesArray(resourceId) {


        $.ajax({
            type: "POST",
            url: "/booking/getAllBookingServices",
            data: 'id=' + resourceId,
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            dataType: "json",
            async: false,
            success: function (result) {
                serviceArray = [];
                serviceObj = {};
                serviceObj.text = "Vælg";
                serviceObj.value = "0";
                serviceArray.push(serviceObj);

                $.each(result, function (i, data) {
                    serviceObj = {};
                    serviceObj.text = data.name;
                    serviceObj.value = data.id;
                    serviceArray.push(serviceObj);
                });

            },

            failure: function (errMsg) {
                alert(errMsg);
            }
        });


    }

    function addResourceColorTagDiv(jsonResource) {


        var htmlStr = '<div style="margin-bottom : 10px;background-color :' + jsonResource.calendarEntryColor + '">' + jsonResource.jobDescription + '<div>'
        $("#resourceColorTagdiv").append(htmlStr);

    }


</script>


